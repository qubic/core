<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 900">
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
    </marker>
  </defs>

  <!-- Title -->
  <text x="600" y="30" font-family="Arial" font-size="24" font-weight="bold" text-anchor="middle">Stable Computor Index Algorithm</text>

  <!-- Memory Layout Section -->
  <text x="50" y="70" font-family="Arial" font-size="18" font-weight="bold">Memory Layout in tempBuffer:</text>

  <!-- tempBuffer box -->
  <rect x="50" y="85" width="1100" height="60" fill="#f0f0f0" stroke="#333" stroke-width="2"/>

  <!-- tempComputorList section -->
  <rect x="50" y="85" width="600" height="60" fill="#a8d5ba" stroke="#333" stroke-width="2"/>
  <text x="350" y="110" font-family="Arial" font-size="12" text-anchor="middle">tempComputorList[676]</text>
  <text x="350" y="130" font-family="Arial" font-size="11" text-anchor="middle">(m256i array: 676 × 32 = 21,632 bytes)</text>

  <!-- isIndexTaken section -->
  <rect x="650" y="85" width="250" height="60" fill="#f9d56e" stroke="#333" stroke-width="2"/>
  <text x="775" y="110" font-family="Arial" font-size="12" text-anchor="middle">isIndexTaken[676]</text>
  <text x="775" y="130" font-family="Arial" font-size="11" text-anchor="middle">(bool array: 676 bytes)</text>

  <!-- isFutureComputorUsed section -->
  <rect x="900" y="85" width="250" height="60" fill="#f3a683" stroke="#333" stroke-width="2"/>
  <text x="1025" y="110" font-family="Arial" font-size="12" text-anchor="middle">isFutureComputorUsed[676]</text>
  <text x="1025" y="130" font-family="Arial" font-size="11" text-anchor="middle">(bool array: 676 bytes)</text>

  <!-- Pointer arithmetic -->
  <text x="50" y="170" font-family="monospace" font-size="11">m256i* tempComputorList = (m256i*)tempBuffer;</text>
  <text x="50" y="185" font-family="monospace" font-size="11">bool* isIndexTaken = (bool*)(tempComputorList + NUMBER_OF_COMPUTORS);  // advances by 676 × sizeof(m256i) bytes</text>
  <text x="50" y="200" font-family="monospace" font-size="11">bool* isFutureComputorUsed = isIndexTaken + NUMBER_OF_COMPUTORS;       // advances by 676 bytes</text>

  <!-- Example Section -->
  <text x="50" y="240" font-family="Arial" font-size="18" font-weight="bold">Example (simplified to 6 computors):</text>

  <!-- Current Computors (broadcastedComputors) -->
  <text x="50" y="275" font-family="Arial" font-size="14" font-weight="bold">Current Computors (epoch N):</text>
  <g transform="translate(50, 285)">
    <rect x="0" y="0" width="60" height="40" fill="#b8e0d2" stroke="#333"/>
    <text x="30" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 0</text>
    <text x="30" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_A</text>

    <rect x="65" y="0" width="60" height="40" fill="#b8e0d2" stroke="#333"/>
    <text x="95" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 1</text>
    <text x="95" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_B</text>

    <rect x="130" y="0" width="60" height="40" fill="#b8e0d2" stroke="#333"/>
    <text x="160" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 2</text>
    <text x="160" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_C</text>

    <rect x="195" y="0" width="60" height="40" fill="#b8e0d2" stroke="#333"/>
    <text x="225" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 3</text>
    <text x="225" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_D</text>

    <rect x="260" y="0" width="60" height="40" fill="#b8e0d2" stroke="#333"/>
    <text x="290" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 4</text>
    <text x="290" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_E</text>

    <rect x="325" y="0" width="60" height="40" fill="#b8e0d2" stroke="#333"/>
    <text x="355" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 5</text>
    <text x="355" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_F</text>
  </g>

  <!-- Future Computors BEFORE (input) -->
  <text x="50" y="360" font-family="Arial" font-size="14" font-weight="bold">Future Computors BEFORE (sorted by mining score):</text>
  <g transform="translate(50, 370)">
    <rect x="0" y="0" width="60" height="40" fill="#ffeaa7" stroke="#333"/>
    <text x="30" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 0</text>
    <text x="30" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_C</text>

    <rect x="65" y="0" width="60" height="40" fill="#ffeaa7" stroke="#333"/>
    <text x="95" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 1</text>
    <text x="95" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_X</text>

    <rect x="130" y="0" width="60" height="40" fill="#ffeaa7" stroke="#333"/>
    <text x="160" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 2</text>
    <text x="160" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_A</text>

    <rect x="195" y="0" width="60" height="40" fill="#ffeaa7" stroke="#333"/>
    <text x="225" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 3</text>
    <text x="225" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_Y</text>

    <rect x="260" y="0" width="60" height="40" fill="#ffeaa7" stroke="#333"/>
    <text x="290" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 4</text>
    <text x="290" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_E</text>

    <rect x="325" y="0" width="60" height="40" fill="#ffeaa7" stroke="#333"/>
    <text x="355" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 5</text>
    <text x="355" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_B</text>
  </g>
  <text x="450" y="395" font-family="Arial" font-size="11" fill="#666">← ID_C moved from idx 2→0, ID_A from idx 0→2, etc.</text>
  <text x="450" y="410" font-family="Arial" font-size="11" fill="#c0392b">Problem: Requalifying IDs have different indices!</text>

  <!-- Step 1 -->
  <text x="50" y="455" font-family="Arial" font-size="14" font-weight="bold" fill="#2980b9">Step 1: Find requalifying computors, assign to their ORIGINAL index</text>

  <g transform="translate(50, 465)">
    <!-- tempComputorList after step 1 -->
    <rect x="0" y="0" width="60" height="40" fill="#81ecec" stroke="#333"/>
    <text x="30" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 0</text>
    <text x="30" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_A</text>

    <rect x="65" y="0" width="60" height="40" fill="#81ecec" stroke="#333"/>
    <text x="95" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 1</text>
    <text x="95" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_B</text>

    <rect x="130" y="0" width="60" height="40" fill="#81ecec" stroke="#333"/>
    <text x="160" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 2</text>
    <text x="160" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_C</text>

    <rect x="195" y="0" width="60" height="40" fill="#dfe6e9" stroke="#333" stroke-dasharray="4"/>
    <text x="225" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 3</text>
    <text x="225" y="30" font-family="Arial" font-size="10" text-anchor="middle" fill="#999">empty</text>

    <rect x="260" y="0" width="60" height="40" fill="#81ecec" stroke="#333"/>
    <text x="290" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 4</text>
    <text x="290" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_E</text>

    <rect x="325" y="0" width="60" height="40" fill="#dfe6e9" stroke="#333" stroke-dasharray="4"/>
    <text x="355" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 5</text>
    <text x="355" y="30" font-family="Arial" font-size="10" text-anchor="middle" fill="#999">empty</text>
  </g>

  <!-- Tracking arrays -->
  <g transform="translate(500, 465)">
    <text x="0" y="0" font-family="Arial" font-size="11">isIndexTaken:</text>
    <rect x="100" y="-12" width="25" height="18" fill="#27ae60" stroke="#333"/>
    <text x="112" y="2" font-family="Arial" font-size="9" text-anchor="middle" fill="white">T</text>
    <rect x="127" y="-12" width="25" height="18" fill="#27ae60" stroke="#333"/>
    <text x="139" y="2" font-family="Arial" font-size="9" text-anchor="middle" fill="white">T</text>
    <rect x="154" y="-12" width="25" height="18" fill="#27ae60" stroke="#333"/>
    <text x="166" y="2" font-family="Arial" font-size="9" text-anchor="middle" fill="white">T</text>
    <rect x="181" y="-12" width="25" height="18" fill="#e74c3c" stroke="#333"/>
    <text x="193" y="2" font-family="Arial" font-size="9" text-anchor="middle" fill="white">F</text>
    <rect x="208" y="-12" width="25" height="18" fill="#27ae60" stroke="#333"/>
    <text x="220" y="2" font-family="Arial" font-size="9" text-anchor="middle" fill="white">T</text>
    <rect x="235" y="-12" width="25" height="18" fill="#e74c3c" stroke="#333"/>
    <text x="247" y="2" font-family="Arial" font-size="9" text-anchor="middle" fill="white">F</text>

    <text x="0" y="25" font-family="Arial" font-size="11">isFutureUsed:</text>
    <rect x="100" y="13" width="25" height="18" fill="#27ae60" stroke="#333"/>
    <text x="112" y="27" font-family="Arial" font-size="9" text-anchor="middle" fill="white">T</text>
    <rect x="127" y="13" width="25" height="18" fill="#e74c3c" stroke="#333"/>
    <text x="139" y="27" font-family="Arial" font-size="9" text-anchor="middle" fill="white">F</text>
    <rect x="154" y="13" width="25" height="18" fill="#27ae60" stroke="#333"/>
    <text x="166" y="27" font-family="Arial" font-size="9" text-anchor="middle" fill="white">T</text>
    <rect x="181" y="13" width="25" height="18" fill="#e74c3c" stroke="#333"/>
    <text x="193" y="27" font-family="Arial" font-size="9" text-anchor="middle" fill="white">F</text>
    <rect x="208" y="13" width="25" height="18" fill="#27ae60" stroke="#333"/>
    <text x="220" y="27" font-family="Arial" font-size="9" text-anchor="middle" fill="white">T</text>
    <rect x="235" y="13" width="25" height="18" fill="#27ae60" stroke="#333"/>
    <text x="247" y="27" font-family="Arial" font-size="9" text-anchor="middle" fill="white">T</text>
    <text x="280" y="27" font-family="Arial" font-size="9" fill="#666">← ID_X, ID_Y unused</text>
  </g>

  <!-- Step 2 -->
  <text x="50" y="555" font-family="Arial" font-size="14" font-weight="bold" fill="#8e44ad">Step 2: Fill empty slots with new computors (ID_X, ID_Y)</text>

  <g transform="translate(50, 565)">
    <rect x="0" y="0" width="60" height="40" fill="#81ecec" stroke="#333"/>
    <text x="30" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 0</text>
    <text x="30" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_A</text>

    <rect x="65" y="0" width="60" height="40" fill="#81ecec" stroke="#333"/>
    <text x="95" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 1</text>
    <text x="95" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_B</text>

    <rect x="130" y="0" width="60" height="40" fill="#81ecec" stroke="#333"/>
    <text x="160" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 2</text>
    <text x="160" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_C</text>

    <rect x="195" y="0" width="60" height="40" fill="#a29bfe" stroke="#333" stroke-width="2"/>
    <text x="225" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 3</text>
    <text x="225" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_X</text>

    <rect x="260" y="0" width="60" height="40" fill="#81ecec" stroke="#333"/>
    <text x="290" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 4</text>
    <text x="290" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_E</text>

    <rect x="325" y="0" width="60" height="40" fill="#a29bfe" stroke="#333" stroke-width="2"/>
    <text x="355" y="15" font-family="Arial" font-size="10" text-anchor="middle">idx 5</text>
    <text x="355" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ID_Y</text>
  </g>
  <text x="450" y="590" font-family="Arial" font-size="11" fill="#8e44ad">← New computors fill vacated slots (D→X, F→Y)</text>

  <!-- Final Result -->
  <text x="50" y="650" font-family="Arial" font-size="14" font-weight="bold" fill="#27ae60">Result: Future Computors AFTER (stable indices):</text>
  <g transform="translate(50, 660)">
    <rect x="0" y="0" width="60" height="40" fill="#00b894" stroke="#333"/>
    <text x="30" y="15" font-family="Arial" font-size="10" text-anchor="middle" fill="white">idx 0</text>
    <text x="30" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold" fill="white">ID_A</text>

    <rect x="65" y="0" width="60" height="40" fill="#00b894" stroke="#333"/>
    <text x="95" y="15" font-family="Arial" font-size="10" text-anchor="middle" fill="white">idx 1</text>
    <text x="95" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold" fill="white">ID_B</text>

    <rect x="130" y="0" width="60" height="40" fill="#00b894" stroke="#333"/>
    <text x="160" y="15" font-family="Arial" font-size="10" text-anchor="middle" fill="white">idx 2</text>
    <text x="160" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold" fill="white">ID_C</text>

    <rect x="195" y="0" width="60" height="40" fill="#6c5ce7" stroke="#333"/>
    <text x="225" y="15" font-family="Arial" font-size="10" text-anchor="middle" fill="white">idx 3</text>
    <text x="225" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold" fill="white">ID_X</text>

    <rect x="260" y="0" width="60" height="40" fill="#00b894" stroke="#333"/>
    <text x="290" y="15" font-family="Arial" font-size="10" text-anchor="middle" fill="white">idx 4</text>
    <text x="290" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold" fill="white">ID_E</text>

    <rect x="325" y="0" width="60" height="40" fill="#6c5ce7" stroke="#333"/>
    <text x="355" y="15" font-family="Arial" font-size="10" text-anchor="middle" fill="white">idx 5</text>
    <text x="355" y="30" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold" fill="white">ID_Y</text>
  </g>

  <!-- Legend -->
  <g transform="translate(500, 660)">
    <rect x="0" y="0" width="20" height="20" fill="#00b894" stroke="#333"/>
    <text x="30" y="15" font-family="Arial" font-size="11">Requalifying (kept same index)</text>

    <rect x="0" y="25" width="20" height="20" fill="#6c5ce7" stroke="#333"/>
    <text x="30" y="40" font-family="Arial" font-size="11">New computor (fills vacated slot)</text>
  </g>

  <!-- Key benefit box -->
  <rect x="50" y="730" width="700" height="70" fill="#e8f8f5" stroke="#1abc9c" stroke-width="2" rx="5"/>
  <text x="70" y="755" font-family="Arial" font-size="13" font-weight="bold" fill="#1abc9c">Key Benefit for Execution Fee Reporting:</text>
  <text x="70" y="775" font-family="Arial" font-size="12">ID_A reports at ticks where tick % 676 == 0 in BOTH epochs</text>
  <text x="70" y="790" font-family="Arial" font-size="12">ID_B reports at ticks where tick % 676 == 1 in BOTH epochs → No gaps, no duplicates!</text>

</svg>
